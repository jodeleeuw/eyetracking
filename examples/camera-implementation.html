<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <title>Test Camera</title>
  <script src="../dist/bundle.js"></script>
  <link rel="stylesheet" href="ci-class.css" />
</head>
<body>
  <button id="askPerm">Click me to ask for permission!</button>
  <div id="metricPanel" class="panel">
    <p id="metadata" class="metrics"></p>
    <p id="frameCounter" class="metrics"></p>
    <p id="fps" class="metrics"></p>
  </div>
</body>
<script>
  var Eyetracker = eyetrack.initEyetracker();

  // create button to ask for permission
  const btn = document.getElementById("askPerm");
  btn.addEventListener("click", askPermission);

  // initializes eyetracker and gets camera list
  async function askPermission() {
    await Eyetracker.init();
    await Eyetracker.getCameraPermission();
    const btn = document.getElementById("askPerm");
    btn.remove();
    updateCameraSelect();
  }

  // creates selector with camera list
  // TODO: bypass if devices.length == 1
  async function updateCameraSelect() {
    const devices = await Eyetracker.getListOfCameras();
    const selector = document.createElement("select");
    selector.id = "cameraList";
    selector.name = "cameras";

    const blank = document.createElement("option");
    blank.style.display = "none";
    selector.appendChild(blank);

    devices.forEach((d) => {
      let op = document.createElement("option");
      op.value = d.deviceId;
      op.innerHTML = d.label;

      selector.appendChild(op);
    });

    let message = document.createElement("p");
    message.id = "text";
    message.innerHTML = "Please select the camera you'd like to use.";
    document.body.appendChild(message);

    document.body.appendChild(selector);

    const btnSelect = document.createElement("button");
    btnSelect.id = "btnSelect";
    btnSelect.innerHTML = "SELECT";
    btnSelect.addEventListener("click", startDetection);
    document.body.appendChild(btnSelect);
  }

  // creates camera and face projection feeds
  // TODO: add error handling if user selects the blank option
  async function startDetection() {
    const selector = document.getElementById("cameraList");
    const id = selector.options[selector.selectedIndex].value;
    await Eyetracker.setCamera(
      await navigator.mediaDevices.getUserMedia({ video: { deviceId: id } })
    );

    selector.remove();
    const btn = document.getElementById("btnSelect");
    btn.remove();
    const text = document.getElementById("text");
    text.remove();

    await Eyetracker.createVideo("cameraFeed");
    await Eyetracker.createDisplay("projectionFeed");

    Eyetracker.generateFaceMesh();

    moveCameras();
  }

  // creates divs to organize feeds
  async function moveCameras() {
    const vidsContainer = document.createElement("div");
    vidsContainer.id = "vidContainer";
    vidsContainer.style.display = "flex";
    const camContainer = document.createElement("div");
    camContainer.id = "camContainer";
    camContainer.style.flexBasis = "auto";
    const projContainer = document.createElement("div");
    projContainer.id = "projContainer";
    projContainer.style.flexBasis = "auto";

    vidsContainer.appendChild(camContainer);
    vidsContainer.appendChild(projContainer);
    document.body.insertBefore(vidsContainer, document.body.firstChild);

    camContainer.appendChild(document.getElementById("cameraFeed"));
    projContainer.appendChild(document.getElementById("projectionFeed"));
    await generateLabels();
  }

  let number = 0;

  async function generateLabels() {
    const timeCounter = document.createElement("p");
    timeCounter.id = "time";
    timeCounter.className = "metrics";
    timeCounter.textContent = number;

    document.body.appendChild(timeCounter);
    window.requestAnimationFrame(countUp);
  }

  function countUp() {
    number++;

    const timeCounter = document.getElementById("time");
    timeCounter.textContent = number;
    if (number < 500) {
      window.requestAnimationFrame(countUp);
    }
  }

  askPermission;
</script>
