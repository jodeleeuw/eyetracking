<!DOCTYPE html>
<html>
  <head>
    <script src="../dist/bundle.js"></script>
  </head>

  <body></body>
  <script>
    var Eyetracker = eyetrack.initEyetracker();

    async function cameraSetup() {
      try {
        const test = await Eyetracker.getListOfCameras();
        console.log("List of Cameras Acquired...");

        let imageCanvas = document.createElement("canvas");
        imageCanvas.setAttribute("id", "imageCanvas");
        document.body.appendChild(imageCanvas);
        const imgCtx = imageCanvas.getContext("2d");

        await document.createElement("button");
        button = document.createElement("button");
        button.setAttribute("id", "button");
        button.onclick = async () => {
          await Eyetracker.setCamera(await test[0]);
          console.log("Source Object Captured...");

          button.style.visibility = "hidden";

          video1 = await Eyetracker.createVideo("test video");
          //console.log(await Eyetracker.createVideo('test video'));
          console.log("Video Element Created...");

          imageCanvas.height = video1.height;
          imageCanvas.width = video1.width;
          imgCtx.translate(imageCanvas.width, 0);
          imgCtx.scale(-1, 1);
          imgCtx.drawImage(video1, 0, 0, imageCanvas.width, imageCanvas.height);
          console.log(video1.currentTime);

          let repaints = 0;
          let performanceTime1 = 0;
          let performanceTime2 = 0;
          let performanceOffset = 0;
          let videoTime1 = 0;
          let videoTime2 = 0;
          let videoOffset = 0;
          let offset1 = 0;
          let offset2 = 0;

          function showFrame() {
            // const canvas = document.createElement("canvas");
            // canvas.width = video1.width;
            // canvas.height = video1.height;
            // document.body.appendChild(canvas);
            // const ctx = canvas.getContext("2d");
            // ctx.drawImage(video1, 0, 0);
            // const time = document.createElement("p");
            // document.body.appendChild(time);
            // time.textContent = video1.currentTime;
            // window.requestAnimationFrame(showFrame)

            window.requestAnimationFrame(showFrame);
          }
          //showFrame();
          setInterval(() => {
            if (repaints % 2 == 0) {
              performanceTime1 = performance.now();
              videoTime1 = video1.currentTime;
              offset1 = performance.now() / 1000 - video1.currentTime;
              videoOffset = videoTime1 - videoTime2;
              performanceOffset =
                performanceTime1 / 1000 - performanceTime2 / 1000;
              let offsetDiff = performanceOffset - videoOffset;
              let offsetOffset = offset1 - offset2;

              console.log(`performanceOffset: ${performanceOffset}`);
              console.log(`videoOffset: ${videoOffset}`);
              console.log(`offset1: ${offset1}`);
              console.log(`offsetDiff: ${offsetDiff}`);
              console.log(`offsetOffset: ${offsetOffset}`);
              repaints++;
            } else {
              performanceTime2 = performance.now();
              videoTime2 = video1.currentTime;
              offset2 = performance.now() / 1000 - video1.currentTime;
              videoOffset = videoTime2 - videoTime1;
              performanceOffset =
                performanceTime2 / 1000 - performanceTime1 / 1000;
              let offsetDiff = performanceOffset - videoOffset;
              let offsetOffset = offset2 - offset1;

              console.log(`performanceOffset: ${performanceOffset}`);
              console.log(`videoOffset: ${videoOffset}`);
              console.log(`offset2: ${offset2}`);
              console.log(`offsetDiff: ${offsetDiff}`);
              console.log(`offsetOffset: ${offsetOffset}`);
              repaints++;
            }
          }, 3000);
        };
        document.body.appendChild(button);

        // const detector = await Eyetracker.init();
        // //console.log(await Eyetracker.init())
        // console.log("Detector Created...");

        const video = document.getElementById("test video");
      } catch (err) {
        console.log("An error has been detected: " + err);
      }
    }

    cameraSetup();
  </script>
</html>
